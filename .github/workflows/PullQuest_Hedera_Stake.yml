name: PullQuestAI Hedera Stake

on:
  issue_comment:
    types: [created]

jobs:
  handle-hedera-stake:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      BACKEND_URL_HEDERA: https://hedera-smart-contracts.onrender.com
      BACKEND_URL_PULLQUEST: https://pullquestgithubbackend-1.onrender.com
      
    steps:
      - name: Check for stake trigger phrase
        id: check-comment
        run: |
          comment_body="${{ github.event.comment.body }}"
          if [[ "$comment_body" == *"@pullquestai stake"* ]]; then
            echo "trigger_action=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Stake request detected!"
          else
            echo "trigger_action=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Not a stake request, skipping..."
          fi

      - name: Build payload and call staking API
        id: hedra-stake-call
        if: steps.check-comment.outputs.trigger_action == 'true'
        run: |
          githubUsername="${{ github.event.issue.user.login }}"
          repository="${{ github.event.repository.name }}"
          issueNumber="${{ github.event.issue.number }}"
          stakeAmount="1"

          payload=$(jq -n \
            --arg githubUsername "$githubUsername" \
            --arg repository "$repository" \
            --argjson issueNumber "$issueNumber" \
            --arg stakeAmount "$stakeAmount" \
            '{
              githubUsername: $githubUsername,
              repository: $repository,
              issueNumber: $issueNumber,
              stakeAmount: $stakeAmount
            }')

          echo "üì¶ Payload for Hedera stake call:"
          echo "$payload"

          echo "üîÑ Making request to Hedera API..."
          response=$(curl --fail --show-error --silent \
            -X POST "$BACKEND_URL_HEDERA/api/stake" \
            -H "Content-Type: application/json" \
            --data-binary "$payload" || echo "HEDERA_API_FAILED")

          echo "üì• Hedera API Response: $response"
          echo "hedra_response=$response" >> $GITHUB_OUTPUT
          
          # Check if Hedera API call was successful
          if [[ "$response" == "HEDERA_API_FAILED" ]]; then
            echo "‚ùå Hedera API call failed"
            exit 1
          fi

      - name: Post stake comment
        # Only call PullQuest backend after successful Hedera stake
        if: steps.hedra-stake-call.outcome == 'success' && steps.check-comment.outputs.trigger_action == 'true'
        run: |
          echo "üí¨ Posting stake comment..."

          # Create payload matching the exact structure that works
          comment_payload=$(jq -n \
            --arg owner "${{ github.event.repository.owner.login }}" \
            --arg repo "${{ github.event.repository.name }}" \
            --argjson prNumber "${{ github.event.issue.number }}" \
            --arg user "${{ github.event.issue.user.login }}" \
            '{
              owner: $owner,
              repo: $repo,
              prNumber: $prNumber,
              user: $user
            }')

          echo "üì¶ Comment payload:"
          echo "$comment_payload"

          echo "üîÑ Making request to post comment..."
          final_response=$(curl --fail --show-error --silent \
            -X POST "$BACKEND_URL_PULLQUEST/api/comment/stake" \
            -H "Content-Type: application/json" \
            --data-binary "$comment_payload" || echo "COMMENT_POST_FAILED")
          
          echo "üì• API Response: $final_response"
          
          if [[ "$final_response" == "COMMENT_POST_FAILED" ]]; then
            echo "‚ùå Comment posting failed"
            exit 1
          else
            echo "‚úÖ Workflow completed successfully!"
          fi