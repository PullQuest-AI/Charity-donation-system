name: PullQuestAI Bounty Transfer + XP Award

on:
  issue_comment:
    types: [created]

jobs:
  handle-bounty-and-xp:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      BACKEND_URL_HEDERA: https://hedera-smart-contracts.onrender.com
      BACKEND_URL_PULLQUEST: https://pullquestgithubbackend-1.onrender.com
      
    steps:
      - name: Check for bounty award trigger phrase
        id: check-comment
        run: |
          comment_body="${{ github.event.comment.body }}"
          echo "Comment body: $comment_body"
          
          # Check for bounty award pattern: @pullquestai add 50HBAR Bounty to @username
          if [[ "$comment_body" =~ @pullquestai[[:space:]]+add[[:space:]]+([0-9]+\.?[0-9]*)HBAR[[:space:]]+Bounty[[:space:]]+to[[:space:]]+@([a-zA-Z0-9_-]+) ]]; then
            bounty_amount="${BASH_REMATCH[1]}"
            target_username="${BASH_REMATCH[2]}"
            echo "trigger_action=true" >> $GITHUB_OUTPUT
            echo "bounty_amount=$bounty_amount" >> $GITHUB_OUTPUT
            echo "target_username=$target_username" >> $GITHUB_OUTPUT
            echo "‚úÖ Bounty award request detected: ${bounty_amount} HBAR to @${target_username}"
          else
            echo "trigger_action=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Not a bounty award request, skipping..."
          fi

      - name: Fetch recipient wallet address from database
        id: fetch-wallet
        if: steps.check-comment.outputs.trigger_action == 'true'
        run: |
          targetUsername="${{ steps.check-comment.outputs.target_username }}"
          
          echo "üîç Fetching wallet address for @${targetUsername} from database..."
          
          # Simulate database lookup (replace with actual API call)

          wallet_response=$(curl --silent \
            -X GET "$BACKEND_URL_PULLQUEST/api/users/${targetUsername}/wallet" \
            -H "Content-Type: application/json" || echo '{"wallet":"0x2A017065b70cdcDE126Fe674e968Aa63293ABD9a"}')
          
          # Extract wallet address (fallback to self-transfer for demo)
          recipient_wallet=$(echo "$wallet_response" | jq -r '.wallet // "0x2A017065b70cdcDE126Fe674e968Aa63293ABD9a"')
          
          echo "recipient_wallet=$recipient_wallet" >> $GITHUB_OUTPUT
          echo "üìã Found wallet address: $recipient_wallet"

      - name: Execute bounty transfer
        id: bounty-transfer
        if: steps.check-comment.outputs.trigger_action == 'true'
        run: |
          targetUsername="${{ steps.check-comment.outputs.target_username }}"
          bountyAmount="${{ steps.check-comment.outputs.bounty_amount }}"
          recipientWallet="${{ steps.fetch-wallet.outputs.recipient_wallet }}"
          prNumber="${{ github.event.issue.number }}"
          awardedBy="${{ github.event.comment.user.login }}"
          repository="${{ github.event.repository.name }}"
          
          echo "üí∞ Initiating bounty transfer..."
          echo "- Recipient: @${targetUsername}"
          echo "- Wallet: ${recipientWallet}"
          echo "- Amount: ${bountyAmount} HBAR"
          
          # Create transfer payload
          transfer_payload=$(jq -n \
            --arg toAddress "$recipientWallet" \
            --arg amount "$bountyAmount" \
            --arg memo "Bounty payment for @${targetUsername} - ${bountyAmount} HBAR bounty in ${repository} PR #${prNumber} by @${awardedBy}" \
            '{
              toAddress: $toAddress,
              amount: ($amount | tonumber),
              memo: $memo
            }')

          echo "üì¶ Transfer payload:"
          echo "$transfer_payload"

          echo "üîÑ Making bounty transfer request..."
          transfer_response=$(curl --fail --show-error --silent \
            -X POST "$BACKEND_URL_HEDERA/api/bounty/transfer/send" \
            -H "Content-Type: application/json" \
            --data-binary "$transfer_payload" || echo "TRANSFER_FAILED")

          echo "üì• Transfer API Response:"
          echo "$transfer_response"
          echo "transfer_response=$transfer_response" >> $GITHUB_OUTPUT
          
          # Check if transfer was successful
          if [[ "$transfer_response" == "TRANSFER_FAILED" ]]; then
            echo "‚ùå Bounty transfer failed"
            exit 1
          fi
          
          # Extract transfer details
          transfer_tx_hash=$(echo "$transfer_response" | jq -r '.data.txHash // "N/A"')
          transfer_amount_sent=$(echo "$transfer_response" | jq -r '.data.amountTransferred // "0"')
          
          echo "transfer_tx_hash=$transfer_tx_hash" >> $GITHUB_OUTPUT
          echo "transfer_amount_sent=$transfer_amount_sent" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Bounty transfer completed successfully!"
          echo "- Transaction Hash: $transfer_tx_hash"
          echo "- Amount Sent: $transfer_amount_sent HBAR"

      - name: Build payload and call comment API (skip XP for bounty-only workflow)
        id: bounty-comment-call
        if: steps.bounty-transfer.outcome == 'success' && steps.check-comment.outputs.trigger_action == 'true'
        run: |
          targetUsername="${{ steps.check-comment.outputs.target_username }}"
          bountyAmount="${{ steps.check-comment.outputs.bounty_amount }}"
          prNumber="${{ github.event.issue.number }}"
          awardedBy="${{ github.event.comment.user.login }}"
          repository="${{ github.event.repository.name }}"
          transferTxHash="${{ steps.bounty-transfer.outputs.transfer_tx_hash }}"
          transferAmount="${{ steps.bounty-transfer.outputs.transfer_amount_sent }}"

          echo "üìù Preparing bounty comment (no XP award for this workflow)..."
          echo "- Bounty Amount: ${transferAmount} HBAR"
          echo "- Transaction Hash: ${transferTxHash}"

      - name: Extract transaction details from responses
        id: extract-details
        if: steps.hedera-xp-call.outcome == 'success' && steps.check-comment.outputs.trigger_action == 'true'
        run: |
          hedera_response="${{ steps.hedera-xp-call.outputs.hedera_xp_response }}"
          transfer_response="${{ steps.bounty-transfer.outputs.transfer_response }}"
          
          # Extract XP details
          xp_tx_hash=$(echo "$hedera_response" | jq -r '.data.txHash // "N/A"')
          total_xp=$(echo "$hedera_response" | jq -r '.data.totalXp // "0"')
          
          # Transfer details already extracted
          transfer_tx_hash="${{ steps.bounty-transfer.outputs.transfer_tx_hash }}"
          transfer_amount="${{ steps.bounty-transfer.outputs.transfer_amount_sent }}"
          
          echo "xp_tx_hash=$xp_tx_hash" >> $GITHUB_OUTPUT
          echo "total_xp=$total_xp" >> $GITHUB_OUTPUT
          
          echo "üìã Extracted transaction details:"
          echo "- XP Transaction Hash: $xp_tx_hash"
          echo "- Total XP: $total_xp"
          echo "- Transfer Transaction Hash: $transfer_tx_hash"
          echo "- Transfer Amount: $transfer_amount HBAR"

      - name: Post bounty reward comment
        if: steps.bounty-transfer.outcome == 'success' && steps.check-comment.outputs.trigger_action == 'true'
        run: |
          echo "üí¨ Posting bounty reward comment..."

          targetUsername="${{ steps.check-comment.outputs.target_username }}"
          bountyAmount="${{ steps.check-comment.outputs.bounty_amount }}"
          awardedBy="${{ github.event.comment.user.login }}"
          transferTxHash="${{ steps.bounty-transfer.outputs.transfer_tx_hash }}"
          transferAmount="${{ steps.bounty-transfer.outputs.transfer_amount_sent }}"

          # Create payload for bounty comment posting
          comment_payload=$(jq -n \
            --arg owner "${{ github.event.repository.owner.login }}" \
            --arg repo "${{ github.event.repository.name }}" \
            --argjson prNumber "${{ github.event.issue.number }}" \
            --arg targetUser "$targetUsername" \
            --arg awardedBy "$awardedBy" \
            --arg transferTxHash "$transferTxHash" \
            --arg transferAmount "$transferAmount" \
            '{
              owner: $owner,
              repo: $repo,
              prNumber: $prNumber,
              targetUser: $targetUser,
              awardedBy: $awardedBy,
              transferTxHash: $transferTxHash,
              transferAmount: $transferAmount,
              rewardType: "bounty_only"
            }')

          echo "üì¶ Bounty comment payload:"
          echo "$comment_payload"

          echo "üîÑ Making request to post bounty reward comment..."
          final_response=$(curl --fail --show-error --silent \
            -X POST "$BACKEND_URL_PULLQUEST/api/comment/BountyHedera" \
            -H "Content-Type: application/json" \
            --data-binary "$comment_payload" || echo "COMMENT_POST_FAILED")
          
          echo "üì• Comment API Response: $final_response"
          
          if [[ "$final_response" == "COMMENT_POST_FAILED" ]]; then
            echo "‚ùå Comment posting failed"
            exit 1
          else
            echo "‚úÖ Bounty Transfer workflow completed successfully!"
          fi

      - name: Workflow summary
        if: always()
        run: |
          echo "üìã Workflow Execution Summary:"
          echo "================================"
          echo "- Trigger detected: ${{ steps.check-comment.outputs.trigger_action }}"
          echo "- Target user: ${{ steps.check-comment.outputs.target_username }}"
          echo "- XP Points: ${{ steps.check-comment.outputs.xp_points }}"
          echo "- Recipient wallet: ${{ steps.fetch-wallet.outputs.recipient_wallet }}"
          echo "- Transfer outcome: ${{ steps.bounty-transfer.outcome }}"
          echo "- Transfer amount: ${{ steps.bounty-transfer.outputs.transfer_amount_sent }} HBAR"
          echo "- Transfer TX: ${{ steps.bounty-transfer.outputs.transfer_tx_hash }}"
          echo "- XP API outcome: ${{ steps.hedera-xp-call.outcome }}"
          echo "- XP TX: ${{ steps.extract-details.outputs.xp_tx_hash }}"
          echo "- Total XP: ${{ steps.extract-details.outputs.total_xp }}"
          echo "================================"